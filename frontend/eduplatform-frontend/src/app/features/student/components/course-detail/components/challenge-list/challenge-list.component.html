<div class="challenges-container">
  <!-- Header Section -->
  <div class="section-header">
    <h2>üèÜ Retos del Curso</h2>
    <p class="subtitle">
      Completa retos opcionales para ganar bonificaciones XP
    </p>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading">
    <div class="spinner"></div>
    <p>Cargando retos...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && challenges.length === 0" class="empty-state">
    <div class="empty-icon">
      <svg
        width="80"
        height="80"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
        <path d="M4 22h16" />
      </svg>
    </div>
    <h3 class="empty-title">No hay retos disponibles</h3>
    <p class="empty-description">
      El profesor a√∫n no ha publicado retos para este curso
    </p>
  </div>

  <!-- Challenges Grid -->
  <div *ngIf="!isLoading && challenges.length > 0" class="challenges-grid">
    <div *ngFor="let challenge of challenges" class="challenge-card">
      <!-- Card Header -->
      <div class="card-header">
        <div class="header-left">
          <h3 class="challenge-title">{{ challenge.title }}</h3>
          <div class="challenge-badges">
            <span
              class="badge difficulty"
              [style.background-color]="
                getDifficultyColor(challenge.difficulty)
              "
            >
              {{ challenge.difficulty }}
            </span>
            <span class="badge points">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <polygon
                  points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
                />
              </svg>
              +{{ challenge.maxBonusPoints }} XP
            </span>
          </div>
        </div>

        <!-- Status Badge -->
        <div
          *ngIf="hasSubmitted(challenge.id!)"
          class="status-badge"
          [class]="getStatusBadgeClass(getMySubmission(challenge.id!)?.status)"
        >
          {{ getStatusText(getMySubmission(challenge.id!)?.status) }}
        </div>
      </div>

      <!-- Card Body -->
      <div class="card-body">
        <p class="challenge-description">{{ challenge.description }}</p>

        <div class="challenge-info">
          <div class="info-item" *ngIf="challenge.deadline">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
              <line x1="16" y1="2" x2="16" y2="6" />
              <line x1="8" y1="2" x2="8" y2="6" />
              <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
            <span>Fecha l√≠mite: {{ challenge.deadline | date : "short" }}</span>
          </div>
          <div class="info-item" *ngIf="challenge.fileName">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"
              />
              <polyline points="13 2 13 9 20 9" />
            </svg>
            <span>{{ challenge.fileName }}</span>
          </div>
        </div>

        <!-- Submission Info -->
        <div
          *ngIf="
            hasSubmitted(challenge.id!) &&
            getMySubmission(challenge.id!) as submission
          "
          class="submission-info"
        >
          <div class="submission-header">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="20 6 9 17 4 12" />
            </svg>
            <span>Soluci√≥n Enviada</span>
          </div>

          <div class="submission-details">
            <p>
              <strong>üìÖ Enviado:</strong>
              {{ submission.submittedAt | date : "short" }}
            </p>
            <p *ngIf="submission.fileName">
              <strong>üìé Archivo:</strong> {{ submission.fileName }}
            </p>

            <!-- Si est√° revisado -->
            <div
              *ngIf="submission.status === 'REVIEWED'"
              class="reviewed-section"
            >
              <div class="bonus-display">
                <span class="bonus-label">Bonificaci√≥n obtenida:</span>
                <span class="bonus-value"
                  >+{{ submission.bonusPoints }} XP</span
                >
              </div>
              <div *ngIf="submission.feedback" class="feedback-box">
                <strong>üí¨ Retroalimentaci√≥n:</strong>
                <p>{{ submission.feedback }}</p>
              </div>
            </div>

            <!-- Si est√° pendiente -->
            <div
              *ngIf="submission.status === 'PENDING'"
              class="pending-section"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>
              <span>‚è≥ Esperando revisi√≥n del profesor</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Card Footer -->
      <div class="card-footer">
        <!-- Descargar Reto -->
        <button
          class="footer-btn"
          (click)="downloadChallenge(challenge)"
          *ngIf="challenge.fileName"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
          </svg>
          Descargar Reto
        </button>

        <!-- Botones de Acci√≥n -->
        <ng-container *ngIf="!hasSubmitted(challenge.id!)">
          <!-- Subir Primera Soluci√≥n -->
          <button
            class="footer-btn primary"
            (click)="openSubmissionModal(challenge)"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
            Subir Soluci√≥n
          </button>
        </ng-container>

        <ng-container
          *ngIf="
            hasSubmitted(challenge.id!) &&
            getMySubmission(challenge.id!) as submission
          "
        >
          <!-- Descargar Mi Soluci√≥n -->
          <button
            class="footer-btn secondary"
            (click)="downloadMySubmission(submission)"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7 10 12 15 17 10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            Descargar Mi Soluci√≥n
          </button>

          <!-- Editar Soluci√≥n (solo si puede) -->
          <button
            class="footer-btn edit-btn"
            (click)="openSubmissionModal(challenge, submission)"
            [disabled]="!submission.canBeEdited"
            [title]="
              submission.canBeEdited
                ? 'Editar soluci√≥n'
                : 'No puedes editar: ' +
                  (submission.status === 'REVIEWED'
                    ? 'ya fue revisada'
                    : 'plazo expirado')
            "
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M12 20h9" />
              <path
                d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
              />
            </svg>
            {{ submission.canBeEdited ? "Editar Soluci√≥n" : "No Editable" }}
          </button>

          <!-- BOT√ìN DE ELIMINAR -->
          <button
            *ngIf="
              submission.status !== 'REVIEWED' &&
              submission.status !== 'REJECTED'
            "
            class="footer-btn danger-btn"
            (click)="deleteChallengeSubmission(challenge)"
            [title]="'Eliminar tu soluci√≥n de ' + challenge.title"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="3 6 5 6 21 6" />
              <path
                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
              />
              <line x1="10" y1="11" x2="10" y2="17" />
              <line x1="14" y1="11" x2="14" y2="17" />
            </svg>
            Eliminar Soluci√≥n
          </button>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Subir/Editar Soluci√≥n -->
<app-challenge-submission-modal
  *ngIf="showSubmissionModal && selectedChallenge"
  [challenge]="selectedChallenge"
  [existingSubmission]="existingSubmission"
  (closeModal)="closeSubmissionModal()"
  (submissionCreated)="onSubmissionCreated($event)"
>
</app-challenge-submission-modal>

<!-- Modal Confirmaci√≥n Eliminar Soluci√≥n -->
<app-confirmation-modal
  *ngIf="showDeleteSubmissionModal && submissionToDelete"
  title="¬øEliminar soluci√≥n?"
  [message]="getDeleteSubmissionMessage()"
  confirmText="Eliminar"
  cancelText="Cancelar"
  type="danger"
  (confirm)="confirmDeleteSubmission()"
  (cancel)="cancelDeleteSubmission()"
>
</app-confirmation-modal>
