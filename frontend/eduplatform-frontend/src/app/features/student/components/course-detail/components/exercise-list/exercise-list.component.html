<!-- Loading State -->
<div *ngIf="isLoading" class="loading-state" role="status" aria-live="polite">
  <div class="spinner-container">
    <div class="spinner"></div>
    <div class="spinner-glow"></div>
  </div>
  <p class="loading-text">Cargando ejercicios...</p>
</div>

<!-- Empty State -->
<div *ngIf="!isLoading && exercises.length === 0" class="empty-state">
  <div class="empty-icon-wrapper">
    <div class="empty-icon">
      <svg
        width="64"
        height="64"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path
          d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
        ></path>
        <polyline points="14 2 14 8 20 8"></polyline>
      </svg>
    </div>
  </div>
  <h3 class="empty-title">No hay ejercicios disponibles</h3>
  <p class="empty-description">
    El profesor a√∫n no ha agregado ejercicios a este curso
  </p>
</div>

<!-- Exercises Grid -->
<div *ngIf="!isLoading && exercises.length > 0" class="content-grid">
  <article
    *ngFor="let exercise of exercises"
    class="content-card exercise-card"
    [class.completed]="hasSubmission(exercise)"
    [class.graded]="getSubmission(exercise)?.status === 'GRADED'"
  >
    <!-- Status Badge Superior -->
    <div class="status-badge" *ngIf="hasSubmission(exercise)">
      <svg
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
      {{ getSubmissionStatusText(exercise) }}
    </div>

    <!-- Card Header -->
    <div class="card-header">
      <div class="card-header-left">
        <h3 class="card-title">{{ exercise.title }}</h3>
        <div class="card-badges">
          <span
            class="badge difficulty-badge"
            [style.background-color]="getDifficultyColor(exercise.difficulty)"
          >
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
              <circle cx="12" cy="12" r="10"></circle>
            </svg>
            {{ exercise.difficulty }}
          </span>

          <!-- Badge de Deadline Warning -->
          <span
            *ngIf="
              getDaysUntilDeadline(exercise) !== null &&
              getDaysUntilDeadline(exercise)! <= 3
            "
            class="badge deadline-warning"
            [class.expired]="getDaysUntilDeadline(exercise) === 0"
          >
            {{ getDeadlineMessage(exercise) }}
          </span>
        </div>
      </div>
    </div>

    <!-- Card Body -->
    <div class="card-body">
      <p class="card-description">{{ exercise.description }}</p>

      <div class="card-meta-info">
        <div class="meta-info-item" *ngIf="exercise.deadline">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          <span>Fecha l√≠mite: {{ exercise.deadline | date : "short" }}</span>
        </div>
        <div class="meta-info-item" *ngIf="exercise.hasFile">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"
            ></path>
            <polyline points="13 2 13 9 20 9"></polyline>
          </svg>
          <span>Archivo adjunto</span>
        </div>
        <div class="meta-info-item" *ngIf="exercise.hasExternalUrl">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
            ></path>
            <path
              d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
            ></path>
          </svg>
          <span>Enlace externo disponible</span>
        </div>
      </div>

      <!-- Submission Info -->
      <div
        class="submission-info"
        *ngIf="hasSubmission(exercise) && getSubmission(exercise) as submission"
      >
        <div class="submission-header">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>Ejercicio entregado</span>
        </div>

        <div class="submission-details">
          <div class="info-row">
            <div class="info-col">
              <strong>üìÖ Fecha de entrega:</strong>
              <span>{{ submission.submittedAt | date : "short" }}</span>
            </div>
            <div class="info-col">
              <strong>üìé Archivo:</strong>
              <span>{{ submission.fileName }}</span>
            </div>
          </div>

          <!-- Estado de Calificaci√≥n -->
          <div class="grade-status">
            <!-- Pendiente de Calificaci√≥n -->
            <div *ngIf="submission.status === 'PENDING'" class="status-pending">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <div class="status-content">
                <strong>‚è≥ Pendiente de calificaci√≥n</strong>
                <p>El profesor revisar√° tu entrega pronto</p>
              </div>
            </div>

            <!-- Calificado -->
            <div *ngIf="submission.status === 'GRADED'" class="status-graded">
              <div class="grade-header">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                <strong>‚úÖ Calificado</strong>
              </div>

              <div class="grade-box">
                <span class="grade-label">Calificaci√≥n:</span>
                <span
                  class="grade-value"
                  [class.high]="submission.grade! >= 4"
                  [class.medium]="
                    submission.grade! >= 3 && submission.grade! < 4
                  "
                  [class.low]="submission.grade! < 3"
                >
                  {{ submission.grade }}/5.0
                </span>
              </div>

              <p class="graded-date">
                üìÖ Calificado el: {{ submission.gradedAt | date : "short" }}
              </p>

              <!-- Retroalimentaci√≥n -->
              <div *ngIf="submission.feedback" class="feedback-box">
                <div class="feedback-header">
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                    ></path>
                  </svg>
                  <strong>Retroalimentaci√≥n del profesor:</strong>
                </div>
                <p class="feedback-text">{{ submission.feedback }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card Footer -->
    <div class="card-footer">
      <!-- Descargar Ejercicio -->
      <button
        *ngIf="exercise.hasFile"
        class="footer-btn download-btn"
        (click)="onDownloadExercise(exercise)"
        aria-label="Descargar ejercicio"
      >
        <svg
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        <span>Descargar Ejercicio</span>
      </button>

      <!-- Abrir URL Externa -->
      <button
        *ngIf="exercise.hasExternalUrl"
        class="footer-btn link-btn"
        (click)="onOpenExternalUrl(exercise.externalUrl!)"
        aria-label="Abrir enlace externo"
      >
        <svg
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"
          ></path>
          <polyline points="15 3 21 3 21 9"></polyline>
          <line x1="10" y1="14" x2="21" y2="3"></line>
        </svg>
        <span>Abrir Enlace Externo</span>
      </button>

      <!-- Subir/Editar/Descargar seg√∫n estado -->
      <ng-container *ngIf="!hasSubmission(exercise)">
        <button
          class="footer-btn primary-btn"
          (click)="onUploadExercise(exercise)"
          aria-label="Subir entrega"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          <span>Subir Entrega</span>
        </button>
      </ng-container>

      <ng-container
        *ngIf="hasSubmission(exercise) && getSubmission(exercise) as submission"
      >
        <button
          class="footer-btn secondary-btn"
          (click)="onDownloadSubmission(exercise)"
          aria-label="Descargar mi entrega"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          <span>Descargar Mi Entrega</span>
        </button>

        <button
          class="footer-btn edit-btn"
          (click)="onEditSubmission(exercise)"
          [disabled]="!submission.canBeEdited"
          [title]="
            submission.canBeEdited
              ? 'Editar tu entrega'
              : 'No puedes editar: ' +
                (submission.status === 'GRADED'
                  ? 'ya fue calificada'
                  : 'plazo expirado')
          "
          aria-label="Editar entrega"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M12 20h9"></path>
            <path
              d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
            ></path>
          </svg>
          <span>{{
            submission.canBeEdited ? "Editar Entrega" : "No Editable"
          }}</span>
        </button>

        <button
          *ngIf="submission.status !== 'GRADED'"
          class="footer-btn danger-btn"
          (click)="onDeleteSubmission(exercise)"
          aria-label="Eliminar entrega"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="3 6 5 6 21 6"></polyline>
            <path
              d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
            ></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
          <span>Eliminar</span>
        </button>
      </ng-container>
    </div>
  </article>
</div>
